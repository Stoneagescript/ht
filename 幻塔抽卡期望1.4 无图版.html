<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¹»å¡”å¡æ± æ¨¡æ‹Ÿå™¨</title>
    <style>
        .gacha-simulator {
            font-family: Arial, sans-serif;
            background-color: #2C3E50;
            color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 600px;
            margin: 20px auto;
            text-align: center;
        }
        .gacha-simulator h1 {
            font-size: 24px;
            margin-bottom: 20px;
        }
        .gacha-simulator label {
            display: block;
            margin: 10px 0;
            font-size: 16px;
        }
        .gacha-simulator input[type="number"],
        .gacha-simulator select {
            padding: 10px;
            width: 80%;
            max-width: 300px;
            border: none;
            border-radius: 5px;
            background-color: #34495E;
            color: white;
        }
        .gacha-simulator button {
            padding: 10px 20px;
            background-color: #3498DB;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 0;
        }
        .gacha-simulator button:hover {
            background-color: #2980B9;
        }
        .gacha-simulator .result {
            margin-top: 20px;
            font-size: 16px;
            background-color: #34495E;
            padding: 15px;
            border-radius: 5px;
            text-align: left;
        }
    </style>
</head>
<body>
    <div class="gacha-simulator">
        <h1>ğŸŒ¸ å¹»å¡”å¡æ± æ¨¡æ‹Ÿå™¨ ğŸŒ¸</h1>
        <label for="history">å†å²è®°å½•ï¼ˆæœ€è¿‘3æ¬¡ï¼‰ï¼š</label>
        <select id="history">
            <option value="">è¯·é€‰æ‹©å†å²è®°å½•</option>
            <option value="ä¸­ä¸­ä¸­">ä¸­ä¸­ä¸­</option>
            <option value="ä¸­ä¸­æ­ª">ä¸­ä¸­æ­ª</option>
            <option value="ä¸­æ­ªä¸­">ä¸­æ­ªä¸­</option>
            <option value="ä¸­æ­ªæ­ª">ä¸­æ­ªæ­ª</option>
            <option value="æ­ªä¸­ä¸­">æ­ªä¸­ä¸­</option>
            <option value="æ­ªä¸­æ­ª">æ­ªä¸­æ­ª</option>
            <option value="æ­ªæ­ªä¸­">æ­ªæ­ªä¸­</option>
            <option value="æ­ªæ­ªæ­ª">æ­ªæ­ªæ­ª</option>
        </select>
        <label for="pulls">èµ¤æ ¸æ•°é‡ï¼š</label>
        <input id="pulls" type="number" placeholder="è¯·è¾“å…¥ä½ æ‹¥æœ‰çš„èµ¤æ ¸æ•°é‡">
        <label for="target">ç›®æ ‡æ˜Ÿçº§ï¼š</label>
        <select id="target">
            <option value="0">0æ˜Ÿ</option>
            <option value="1">1æ˜Ÿ</option>
            <option value="2">2æ˜Ÿ</option>
            <option value="3">3æ˜Ÿ</option>
            <option value="4">4æ˜Ÿ</option>
            <option value="5">5æ˜Ÿ</option>
            <option value="6">6æ˜Ÿ</option>
        </select>
        <button onclick="simulate()">å¼€å§‹æ¨¡æ‹Ÿ</button>
        <div class="result" id="result"></div>
    </div>

    <script>
        function parseHistory(historyStr) {
            const validChars = [...historyStr].filter(c => c === 'ä¸­' || c === 'æ­ª').slice(-3);
            const state = { pity: 0, consecLimited: 0, consecStandard: 0 };
            for (const char of validChars.reverse()) {
                if (char === 'ä¸­') {
                    if (state.consecStandard >= 2) {
                        state.consecLimited = 1;
                        state.consecStandard = 0;
                    } else {
                        state.consecLimited += 1;
                        state.consecStandard = 0;
                    }
                    state.pity = 0;
                } else if (char === 'æ­ª') {
                    if (state.consecLimited >= 2) {
                        state.consecStandard = 1;
                        state.consecLimited = 0;
                    } else {
                        state.consecStandard += 1;
                        state.consecLimited = 0;
                    }
                    state.pity = 0;
                }
            }
            return state;
        }

        function simulateGacha(pulls, initState) {
            let currentState = { ...initState };
            let limitedCount = 0;
            for (let i = 0; i < pulls; i++) {
                if (currentState.consecStandard >= 2) {
                    limitedCount += 1;
                    currentState.consecLimited = 1;
                    currentState.consecStandard = 0;
                    currentState.pity = 0;
                    continue;
                }
                if (currentState.consecLimited >= 2) {
                    currentState.consecStandard = 1;
                    currentState.consecLimited = 0;
                    currentState.pity = 0;
                    continue;
                }
                const hit = currentState.pity >= 79 || Math.random() < 0.0075;
                if (hit) {
                    if (Math.random() < 0.5) {
                        limitedCount += 1;
                        currentState.consecLimited += 1;
                        currentState.consecStandard = 0;
                    } else {
                        currentState.consecStandard += 1;
                        currentState.consecLimited = 0;
                    }
                    currentState.pity = 0;
                } else {
                    currentState.pity += 1;
                }
                if ((currentState.pity + 1) % 110 === 0) {
                    limitedCount += 1;
                }
            }
            return limitedCount;
        }

        function calculateCoinExchange(totalPulls) {
            return Math.floor(totalPulls / 110);
        }

        function calculateSuccessRate(pulls, target, coinExchange, historyState) {
            let success = 0;
            for (let i = 0; i < 1000; i++) {
                const limitedCount = simulateGacha(pulls, historyState);
                if (limitedCount + coinExchange >= target) {
                    success += 1;
                }
            }
            return success / 1000;
        }

        function recommendTarget(totalPulls, targetStar, coinExchange, historyState) {
            const starToPulls = { 0: 1, 1: 2, 2: 3, 3: 4, 4: 5, 5: 6, 6: 7 };
            const targetPulls = starToPulls[targetStar];
            const successRate = calculateSuccessRate(totalPulls, targetPulls, coinExchange, historyState);
            if (successRate >= 0.5) {
                return `æ¨èç›®æ ‡ï¼š${targetStar} æ˜Ÿï¼ˆéœ€æŠ½ ${targetPulls} æŠŠï¼Œç»¼åˆæˆåŠŸç‡ï¼š${(successRate * 100).toFixed(1)}%ï¼‰`;
            }
            if (targetStar === 5) {
                const successRate3 = calculateSuccessRate(totalPulls, starToPulls[3], coinExchange, historyState);
                if (successRate3 >= 0.5) {
                    return `æ¨èç›®æ ‡ï¼š3 æ˜Ÿï¼ˆéœ€æŠ½ ${starToPulls[3]} æŠŠï¼Œç»¼åˆæˆåŠŸç‡ï¼š${(successRate3 * 100).toFixed(1)}%ï¼‰`;
                } else {
                    const successRate1 = calculateSuccessRate(totalPulls, starToPulls[1], coinExchange, historyState);
                    return `æ¨èç›®æ ‡ï¼š1 æ˜Ÿï¼ˆéœ€æŠ½ ${starToPulls[1]} æŠŠï¼Œç»¼åˆæˆåŠŸç‡ï¼š${(successRate1 * 100).toFixed(1)}%ï¼‰`;
                }
            } else if (targetStar === 6) {
                const successRate5 = calculateSuccessRate(totalPulls, starToPulls[5], coinExchange, historyState);
                if (successRate5 >= 0.5) {
                    return `æ¨èç›®æ ‡ï¼š5 æ˜Ÿï¼ˆéœ€æŠ½ ${starToPulls[5]} æŠŠï¼Œç»¼åˆæˆåŠŸç‡ï¼š${(successRate5 * 100).toFixed(1)}%ï¼‰`;
                } else {
                    const successRate3 = calculateSuccessRate(totalPulls, starToPulls[3], coinExchange, historyState);
                    if (successRate3 >= 0.5) {
                        return `æ¨èç›®æ ‡ï¼š3 æ˜Ÿï¼ˆéœ€æŠ½ ${starToPulls[3]} æŠŠï¼Œç»¼åˆæˆåŠŸç‡ï¼š${(successRate3 * 100).toFixed(1)}%ï¼‰`;
                    } else {
                        const successRate1 = calculateSuccessRate(totalPulls, starToPulls[1], coinExchange, historyState);
                        return `æ¨èç›®æ ‡ï¼š1 æ˜Ÿï¼ˆéœ€æŠ½ ${starToPulls[1]} æŠŠï¼Œç»¼åˆæˆåŠŸç‡ï¼š${(successRate1 * 100).toFixed(1)}%ï¼‰`;
                    }
                }
            }
            return `æ¨èç›®æ ‡ï¼š${targetStar} æ˜Ÿï¼ˆéœ€æŠ½ ${targetPulls} æŠŠï¼Œç»¼åˆæˆåŠŸç‡ï¼š${(successRate * 100).toFixed(1)}%ï¼‰`;
        }

        function simulate() {
            const history = document.getElementById('history').value;
            const pulls = parseInt(document.getElementById('pulls').value);
            const targetStar = parseInt(document.getElementById('target').value);

            if (!history || isNaN(pulls) || isNaN(targetStar)) {
                alert("è¯·è¾“å…¥å®Œæ•´ä¿¡æ¯ï¼");
                return;
            }

            const historyState = parseHistory(history);
            const coinExchange = calculateCoinExchange(pulls);
            const newLimited = simulateGacha(pulls, historyState);
            const recommendation = recommendTarget(pulls, targetStar, coinExchange, historyState);
            const successRate = calculateSuccessRate(pulls, targetStar, coinExchange, historyState);

            document.getElementById('result').innerHTML = `
                <p>é“¸å¸å¯å…‘æ¢é™å®šï¼š${coinExchange}ä¸ª</p>
                <p>é¢„è®¡æ–°å¢é™å®šï¼š${newLimited} Â± 1ä¸ª</p>
                <p>${recommendation}</p>
                <p>ç»¼åˆæˆåŠŸç‡ï¼š${(successRate * 100).toFixed(1)}%</p>
            `;
        }
    </script>
</body>
</html>
